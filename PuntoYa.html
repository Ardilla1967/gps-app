
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PuntoYa! ‚Äî Guardar y Navegar a Puntos GPS</title>
  <meta name="description" content="Guarda ubicaciones GPS, exp√≥rtalas y navega en vivo hacia un punto guardado.">
  <style>
    :root{
      --azul:#1800ad;
      --rojo:#ff3131;
      --amarillo:#ffde59;
      --blanco:#ffffff;
      --gris:#f4f4f7;
      --texto:#1f2937;
      --borde:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--gris);color:var(--texto);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(180deg, rgba(24,0,173,0.95), rgba(24,0,173,0.85));
      color:#fff;
      padding:14px 16px;
      box-shadow:0 4px 20px rgba(0,0,0,.12);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .subtitle{opacity:.9;font-size:13px;margin-top:4px}
    .toolbar{
      margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }
    .lang-selector button{
      border:1px solid rgba(255,255,255,.7);
      background:transparent;color:#fff;padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600
    }
    .lang-selector button.selected{background:#fff;color:var(--azul);border-color:#fff}
    main{padding:12px 16px}
    section.card{
      background:#fff;border:1px solid var(--borde);border-radius:16px;padding:16px;
      box-shadow:0 6px 28px rgba(0,0,0,.06);margin-bottom:16px
    }
    section.card h2{margin:0 0 12px 0;font-size:18px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"], select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--borde);background:#fff;font-size:14px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 240px}
    button{
      appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;
      background:var(--azul);color:#fff;box-shadow:0 6px 20px rgba(24,0,173,.2);
    }
    button.secondary{background:#fff;color:var(--azul);border:1px solid var(--azul)}
    button.warn{background:var(--rojo)}
    button.ghost{background:transparent;color:var(--azul);border:1px dashed var(--azul)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{opacity:.8}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--borde);border-radius:12px;overflow:hidden}
    thead th{background:#f9fafb;font-size:12px;text-align:left;padding:10px;border-bottom:1px solid var(--borde)}
    tbody td{padding:10px;border-bottom:1px solid var(--borde);vertical-align:middle}
    tbody tr:last-child td{border-bottom:0}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:var(--azul);font-weight:700;font-size:12px}
    .kpis{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
    .kpis .kpi{background:#fafafa;border:1px solid var(--borde);border-radius:12px;padding:10px 12px;font-size:14px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    #indicador-direccion{display:none;align-items:center;gap:14px;border:1px dashed var(--borde);padding:12px;border-radius:12px}
    #flecha{width:60px;height:60px;transition:transform .15s ease-out}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
    .small{font-size:12px}
    .ok{color: #0e9f6e;font-weight:700}
    .arrived{color:#0e9f6e;font-weight:800}
    .danger{color:#b91c1c;font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .divider{height:1px;background:var(--borde);margin:10px 0 14px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>PuntoYa!</h1>
      <div class="subtitle" id="app-subtitle">Guarda ubicaciones y navega hacia ellas.</div>
      <div class="toolbar">
        <div class="lang-selector" aria-label="Selector de idioma">
          <button type="button" data-lang="es" aria-label="Cambiar idioma a Espa√±ol">ES</button>
          <button type="button" data-lang="en" aria-label="Change language to English">EN</button>
        </div>
        <div class="right small">
          <span id="contador" class="tag" aria-live="polite">0 puntos</span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card" aria-labelledby="sec-guardar">
      <h2 id="sec-guardar">1) <span data-i18n="guardar_titulo">Guardar ubicaci√≥n actual</span></h2>
      <div class="row">
        <div>
          <label for="nombre" data-i18n="etq_nombre">Nombre</label>
          <input id="nombre" type="text" placeholder="Ej: Casa, Trabajo, √Årbol grande" aria-describedby="nombre-hint">
          <div id="nombre-hint" class="hint" data-i18n="hint_nombre">Si lo dejas vac√≠o, se usar√° la fecha y hora.</div>
        </div>
        <div style="align-self:end">
          <button id="btn-guardar" type="button" aria-label="Guardar ubicaci√≥n actual">
            üíæ <span data-i18n="btn_guardar">Guardar ubicaci√≥n</span>
          </button>
        </div>
      </div>
      <div class="kpis">
        <div class="kpi small"><span data-i18n="gps_estado">GPS:</span> <span id="gps-estado" class="muted">‚Äî</span></div>
        <div class="kpi small"><span data-i18n="gps_ultima">√öltima lectura:</span> <span id="gps-ultima" class="muted">‚Äî</span></div>
      </div>
      <div class="hint" data-i18n="hint_https">Nota: La geolocalizaci√≥n requiere HTTPS o localhost.</div>
    </section>

    <section class="card" aria-labelledby="sec-lista">
      <h2 id="sec-lista">2) <span data-i18n="lista_titulo">Tus ubicaciones</span></h2>
      <div class="row">
        <div>
          <label for="buscar" data-i18n="etq_buscar">Buscar</label>
          <input id="buscar" type="text" placeholder="Filtrar por nombre‚Ä¶">
        </div>
        <div style="align-self:end" class="inline">
          <button id="btn-exportar-csv" class="secondary" type="button">‚¨áÔ∏è <span data-i18n="btn_exportar_csv">Exportar CSV</span></button>
          <button id="btn-exportar-gpx" class="secondary" type="button">‚¨áÔ∏è <span data-i18n="btn_exportar_gpx">Exportar GPX</span></button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div>
          <label for="select-ubicaciones" data-i18n="etq_select">Selecciona un punto</label>
          <select id="select-ubicaciones" aria-label="Punto seleccionado"></select>
          <div class="hint small" data-i18n="hint_select">Usa este selector para abrir el mapa o navegar.</div>
        </div>
        <div style="align-self:end" class="inline">
          <button id="btn-mapa" type="button" class="ghost" aria-label="Abrir en Google Maps">üó∫Ô∏è <span data-i18n="btn_mapa">Abrir en Maps</span></button>
          <button id="btn-navegar" type="button" aria-label="Navegar al punto">üß≠ <span data-i18n="btn_navegar">Navegar</span></button>
          <button id="btn-detener" type="button" class="warn" style="display:none" aria-label="Detener navegaci√≥n">‚õî <span data-i18n="btn_detener">Detener</span></button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div class="inline small muted"><span data-i18n="lista_total">Total:</span>&nbsp;<span id="total"></span></div>
        <div class="right inline small muted">
          <span data-i18n="lista_acciones">Acciones r√°pidas:</span>
          <button id="btn-vaciar" class="ghost small" type="button">üóëÔ∏è <span data-i18n="btn_vaciar">Vaciar lista</span></button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table aria-describedby="tabla-desc">
          <caption id="tabla-desc" class="small muted" style="text-align:left;padding:8px 0" data-i18n="tabla_desc">Lista editable de ubicaciones guardadas</caption>
          <thead>
            <tr>
              <th data-i18n="th_nombre">Nombre</th>
              <th class="mono">Lat</th>
              <th class="mono">Lon</th>
              <th data-i18n="th_fecha">Fecha</th>
              <th data-i18n="th_acciones">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody-ubicaciones"></tbody>
        </table>
      </div>
    </section>

    <section class="card" aria-labelledby="sec-nav">
      <h2 id="sec-nav">3) <span data-i18n="nav_titulo">Navegaci√≥n en vivo</span></h2>
      <div id="indicador-direccion" aria-live="polite">
        <!-- Arrow as inline SVG -->
        <svg id="flecha" viewBox="0 0 100 100" role="img" aria-label="Flecha hacia el destino">
          <polygon points="50,5 65,55 50,45 35,55" />
          <circle cx="50" cy="70" r="6" />
          <rect x="45" y="80" width="10" height="15" rx="3" />
        </svg>
        <div>
          <div id="distancia-info" class="big">‚Äî</div>
          <div id="rumbo-info" class="small muted">‚Äî</div>
          <div id="precision-info" class="small muted">‚Äî</div>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        <button id="btn-permiso-orientacion" class="secondary" style="display:none" type="button">üì± <span data-i18n="btn_permiso_orientacion">Permitir orientaci√≥n del dispositivo</span></button>
        <span class="small muted" data-i18n="hint_orientacion">Si la flecha no se orienta, concede el permiso de orientaci√≥n y mant√©n el tel√©fono en vertical.</span>
      </div>
    </section>
  </main>

  <script>
    // ========================
    // I18N
    // ========================
    const textos = {
      es: {
        subtitulo: "Guarda ubicaciones y navega hacia ellas.",
        guardar_titulo: "Guardar ubicaci√≥n actual",
        etq_nombre: "Nombre",
        hint_nombre: "Si lo dejas vac√≠o, se usar√° la fecha y hora.",
        btn_guardar: "Guardar ubicaci√≥n",
        gps_estado: "GPS:",
        gps_ultima: "√öltima lectura:",
        hint_https: "Nota: La geolocalizaci√≥n requiere HTTPS o localhost.",
        lista_titulo: "Tus ubicaciones",
        etq_buscar: "Buscar",
        btn_exportar_csv: "Exportar CSV",
        btn_exportar_gpx: "Exportar GPX",
        etq_select: "Selecciona un punto",
        hint_select: "Usa este selector para abrir el mapa o navegar.",
        btn_mapa: "Abrir en Maps",
        btn_navegar: "Navegar",
        btn_detener: "Detener",
        lista_total: "Total:",
        lista_acciones: "Acciones r√°pidas:",
        btn_vaciar: "Vaciar lista",
        tabla_desc: "Lista editable de ubicaciones guardadas",
        th_nombre: "Nombre",
        th_fecha: "Fecha",
        th_acciones: "Acciones",
        nav_titulo: "Navegaci√≥n en vivo",
        btn_permiso_orientacion: "Permitir orientaci√≥n del dispositivo",
        hint_orientacion: "Si la flecha no se orienta, concede el permiso de orientaci√≥n y mant√©n el tel√©fono en vertical.",
        guardado_ok: "Ubicaci√≥n guardada.",
        no_hay: "No hay ubicaciones.",
        abrir_maps_error: "Selecciona un punto para abrir en Maps.",
        nav_sin_seleccion: "Selecciona un punto para navegar.",
        nav_iniciada: "Navegaci√≥n iniciada.",
        nav_detendida: "Navegaci√≥n detenida.",
        llegaste: "¬°Llegaste!",
        distancia: "Distancia",
        precision: "Precisi√≥n",
        rumbo: "Rumbo",
        renombrar: "Renombrar",
        eliminar: "Eliminar",
        borrar_todo_confirm: "¬øSeguro que quieres borrar todas las ubicaciones? Esta acci√≥n no se puede deshacer.",
        duplicado: "Ya existe un punto muy cercano; no se a√±adi√≥ un duplicado."
      },
      en: {
        subtitulo: "Save locations and navigate to them.",
        guardar_titulo: "Save current location",
        etq_nombre: "Name",
        hint_nombre: "If left empty, the date and time will be used.",
        btn_guardar: "Save location",
        gps_estado: "GPS:",
        gps_ultima: "Last fix:",
        hint_https: "Note: Geolocation requires HTTPS or localhost.",
        lista_titulo: "Your locations",
        etq_buscar: "Search",
        btn_exportar_csv: "Export CSV",
        btn_exportar_gpx: "Export GPX",
        etq_select: "Pick a point",
        hint_select: "Use this selector to open the map or navigate.",
        btn_mapa: "Open in Maps",
        btn_navegar: "Navigate",
        btn_detener: "Stop",
        lista_total: "Total:",
        lista_acciones: "Quick actions:",
        btn_vaciar: "Clear all",
        tabla_desc: "Editable list of saved locations",
        th_nombre: "Name",
        th_fecha: "Date",
        th_acciones: "Actions",
        nav_titulo: "Live navigation",
        btn_permiso_orientacion: "Allow device orientation",
        hint_orientacion: "If the arrow won't rotate, allow orientation and keep the phone upright.",
        guardado_ok: "Location saved.",
        no_hay: "No saved locations.",
        abrir_maps_error: "Select a point to open in Maps.",
        nav_sin_seleccion: "Select a point to navigate.",
        nav_iniciada: "Navigation started.",
        nav_detendida: "Navigation stopped.",
        llegaste: "Arrived!",
        distancia: "Distance",
        precision: "Accuracy",
        rumbo: "Bearing",
        renombrar: "Rename",
        eliminar: "Delete",
        borrar_todo_confirm: "Are you sure you want to delete all locations? This cannot be undone.",
        duplicado: "A very close point already exists; duplicate not added."
      }
    };
    let lang = (localStorage.getItem('py_lang') || 'es');

    function aplicarTraduccion(){
      document.querySelector('#app-subtitle').textContent = textos[lang].subtitulo;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (textos[lang][key]) el.textContent = textos[lang][key];
      });
      // Update placeholders
      const nombre = document.getElementById('nombre');
      if (nombre) nombre.placeholder = (lang==='es' ? "Ej: Casa, Trabajo, √Årbol grande" : "Ex: Home, Office, Big tree");
      const buscar = document.getElementById('buscar');
      if (buscar) buscar.placeholder = (lang==='es' ? "Filtrar por nombre‚Ä¶" : "Filter by name‚Ä¶");
      // Update selected state in buttons
      document.querySelectorAll('.lang-selector button').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.lang === lang);
      });
      renderizarUbicaciones(); // refresh headers like th_*
      actualizarContador();
    }

    // ========================
    // Storage helpers
    // ========================
    function getUbicaciones(){
      try{
        const arr = JSON.parse(localStorage.getItem('ubicaciones') || '[]');
        if (Array.isArray(arr)) return arr;
      }catch(e){}
      return [];
    }
    function setUbicaciones(arr){
      localStorage.setItem('ubicaciones', JSON.stringify(arr));
    }
    function addUbicacion(u){
      const arr = getUbicaciones();
      arr.push(u);
      setUbicaciones(arr);
    }
    function upsertUbicacionName(id, nuevoNombre){
      const arr = getUbicaciones();
      const idx = arr.findIndex(x=>x.id===id);
      if (idx>=0){ arr[idx].nombre = nuevoNombre; setUbicaciones(arr); }
    }
    function removeUbicacion(id){
      const arr = getUbicaciones().filter(x=>x.id!==id);
      setUbicaciones(arr);
    }
    function clearUbicaciones(){
      localStorage.removeItem('ubicaciones');
    }

    // ========================
    // Geo math
    // ========================
    const R = 6371000; // earth radius m
    const toRad = d => d*Math.PI/180;
    const toDeg = r => r*180/Math.PI;
    function haversineMeters(lat1, lon1, lat2, lon2){
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function initialBearing(lat1, lon1, lat2, lon2){
      const y = Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
      const b = (toDeg(Math.atan2(y,x)) + 360) % 360;
      return b;
    }
    function formatDistance(m){
      return m < 1000 ? Math.round(m) + ' m' : (m/1000).toFixed(1) + ' km';
    }

    // ========================
    // UI Rendering
    // ========================
    function actualizarContador(){
      const total = getUbicaciones().length;
      const tag = document.getElementById('contador');
      if (tag) tag.textContent = (lang==='es' ? `${total} puntos` : `${total} points`);
      const tot = document.getElementById('total');
      if (tot) tot.textContent = String(total);
      // refill selector
      const sel = document.getElementById('select-ubicaciones');
      if (sel){
        const actual = sel.value;
        sel.innerHTML = '';
        const none = document.createElement('option');
        none.value = ''; none.textContent = '‚Äî';
        sel.appendChild(none);
        getUbicaciones().forEach(u=>{
          const o = document.createElement('option');
          o.value = u.id;
          o.textContent = `${u.nombre || '(sin nombre)'} ‚Äî ${u.lat.toFixed(5)}, ${u.lon.toFixed(5)}`;
          sel.appendChild(o);
        });
        // try restore selection
        if ([...sel.options].some(o=>o.value===actual)) sel.value = actual;
      }
    }

    function renderizarUbicaciones(){
      const q = (document.getElementById('buscar')?.value || '').toLowerCase().trim();
      const tbody = document.getElementById('tbody-ubicaciones');
      if (!tbody) return;
      tbody.innerHTML = '';
      const arr = getUbicaciones().filter(u => (u.nombre||'').toLowerCase().includes(q));
      if (!arr.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.setAttribute('colspan','5');
        td.className='small muted';
        td.textContent = textos[lang].no_hay;
        tr.appendChild(td); tbody.appendChild(tr);
        actualizarContador();
        return;
      }
      arr.forEach(u=>{
        const tr = document.createElement('tr');
        const tdNombre = document.createElement('td');
        const input = document.createElement('input');
        input.type='text'; input.value = u.nombre || '';
        input.ariaLabel = (lang==='es'?'Renombrar':'Rename');
        input.addEventListener('change',()=>{
          upsertUbicacionName(u.id, input.value.trim());
          actualizarContador();
        });
        tdNombre.appendChild(input);

        const tdLat = document.createElement('td'); tdLat.className='mono'; tdLat.textContent = Number(u.lat).toFixed(6);
        const tdLon = document.createElement('td'); tdLon.className='mono'; tdLon.textContent = Number(u.lon).toFixed(6);
        const tdFecha = document.createElement('td'); tdFecha.textContent = u.fechaLocal || u.fechaISO || '';

        const tdAcc = document.createElement('td');
        const btnRen = document.createElement('button'); btnRen.className='secondary small'; btnRen.textContent = textos[lang].renombrar;
        btnRen.addEventListener('click',()=>{ input.focus(); input.select(); });
        const btnDel = document.createElement('button'); btnDel.className='warn small'; btnDel.style.marginLeft='6px'; btnDel.textContent = textos[lang].eliminar;
        btnDel.addEventListener('click',()=>{ removeUbicacion(u.id); renderizarUbicaciones(); actualizarContador(); });
        tdAcc.append(btnRen, btnDel);

        tr.append(tdNombre, tdLat, tdLon, tdFecha, tdAcc); tbody.appendChild(tr);
      });
      actualizarContador();
    }

    // ========================
    // Geolocation + Save
    // ========================
    let lastFix = null;
    let watcherId = null;
    let target = null; // {lat,lon}
    let lastHeading = null; // filtered

    function setGpsEstado(text){
      const el = document.getElementById('gps-estado'); if (el) el.textContent = text;
    }
    function setGpsUltima(text){
      const el = document.getElementById('gps-ultima'); if (el) el.textContent = text;
    }

    function guardarUbicacion(){
      if (!navigator.geolocation){
        setGpsEstado('Geolocation no soportada');
        return;
      }
      setGpsEstado(lang==='es'?'Obteniendo‚Ä¶':'Getting‚Ä¶');
      navigator.geolocation.getCurrentPosition(
        pos => {
          lastFix = pos;
          setGpsEstado((lang==='es'?'OK (¬±':'OK (¬±') + Math.round(pos.coords.accuracy||0)+' m)');
          setGpsUltima(new Date().toLocaleString());
          const nombreInput = document.getElementById('nombre');
          const ahora = new Date();
          const u = {
            id: (crypto?.randomUUID && crypto.randomUUID()) || String(ahora.getTime()),
            nombre: (nombreInput?.value || '').trim() || ahora.toLocaleString(),
            fechaISO: ahora.toISOString(),
            fechaLocal: ahora.toLocaleString(),
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
          };
          // de-duplicate (within 3 m)
          const exists = getUbicaciones().some(x => haversineMeters(x.lat, x.lon, u.lat, u.lon) < 3);
          if (exists){
            alert(textos[lang].duplicado);
            return;
          }
          addUbicacion(u);
          nombreInput.value='';
          renderizarUbicaciones();
          actualizarContador();
          alert(textos[lang].guardado_ok);
        },
        err => {
          setGpsEstado((lang==='es'?'Error: ':'Error: ')+err.message);
        },
        {enableHighAccuracy:true, timeout:15000, maximumAge:0}
      );
    }

    // ========================
    // Open in Maps
    // ========================
    function abrirEnMaps(){
      const sel = document.getElementById('select-ubicaciones');
      const id = sel?.value || '';
      if (!id){ alert(textos[lang].abrir_maps_error); return; }
      const u = getUbicaciones().find(x=>x.id===id);
      if (!u) return;
      const url = `https://www.google.com/maps?q=${u.lat},${u.lon}`;
      window.open(url, '_blank', 'noopener');
    }

    // ========================
    // Navigation
    // ========================
    function iniciarNavegacion(){
      const sel = document.getElementById('select-ubicaciones');
      const id = sel?.value || '';
      if (!id){ alert(textos[lang].nav_sin_seleccion); return; }
      const u = getUbicaciones().find(x=>x.id===id);
      target = {lat: Number(u.lat), lon:Number(u.lon)};

      document.getElementById('indicador-direccion').style.display = 'flex';
      document.getElementById('btn-detener').style.display = 'inline-block';
      document.getElementById('distancia-info').textContent = textos[lang].nav_iniciada;
      document.getElementById('rumbo-info').textContent = '‚Äî';
      document.getElementById('precision-info').textContent = '‚Äî';

      // Start watching position
      if (watcherId) { try { navigator.geolocation.clearWatch(watcherId); } catch(e){} }
      watcherId = navigator.geolocation.watchPosition(
        actualizarNavegacion,
        err => { console.warn(err); },
        {enableHighAccuracy:true, timeout:15000, maximumAge:1000}
      );

      // Show orientation permission button for iOS 13+
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent) && typeof DeviceOrientationEvent?.requestPermission === 'function') {
        document.getElementById('btn-permiso-orientacion').style.display = 'inline-block';
      } else {
        // attach listener immediately
        activarOrientacion();
      }
    }

    function detenerNavegacion(){
      if (watcherId) {
        navigator.geolocation.clearWatch(watcherId);
        watcherId = null;
      }
      document.getElementById('indicador-direccion').style.display = 'none';
      document.getElementById('btn-detener').style.display = 'none';
      document.getElementById('btn-permiso-orientacion').style.display = 'none';
      lastHeading = null;
      target = null;
      alert(textos[lang].nav_detendida);
    }

    function actualizarNavegacion(pos){
      if (!target) return;
      const {latitude, longitude, accuracy, heading} = pos.coords;
      const dist = haversineMeters(latitude, longitude, target.lat, target.lon);
      const brg = initialBearing(latitude, longitude, target.lat, target.lon);

      const acc = Math.round(accuracy || 0);
      const arrived = dist < 10;

      document.getElementById('distancia-info').innerHTML = arrived ?
          `<span class="arrived">${textos[lang].llegaste}</span>` :
          `${textos[lang].distancia}: ${formatDistance(dist)}`;
      document.getElementById('precision-info').textContent = `${textos[lang].precision}: ¬±${acc} m`;
      document.getElementById('rumbo-info').textContent = `${textos[lang].rumbo}: ${Math.round(brg)}¬∞`;

      // Which heading to use: device orientation if available; else course from GPS (heading); else 0
      let hdg = (lastHeading!=null ? lastHeading : (typeof heading==='number' && !isNaN(heading) ? heading : 0));
      // normalize
      hdg = (hdg + 360) % 360;

      const rel = (brg - hdg + 360) % 360; // angle to rotate arrow
      const flecha = document.getElementById('flecha');
      flecha.style.transform = `rotate(${rel}deg)`;

      if (arrived){
        // Optionally stop automatically:
        // detenerNavegacion();
      }
    }

    // ========================
    // Orientation handling
    // ========================
    function activarOrientacion(){
      if (window.DeviceOrientationEvent){
        window.addEventListener('deviceorientation', onDeviceOrientation, true);
      }
    }
    function solicitarPermisoOrientacion(){
      if (typeof DeviceOrientationEvent?.requestPermission === 'function'){
        DeviceOrientationEvent.requestPermission().then(state=>{
          if (state==='granted'){
            document.getElementById('btn-permiso-orientacion').style.display='none';
            activarOrientacion();
          }
        }).catch(console.warn);
      } else {
        activarOrientacion();
      }
    }
    function onDeviceOrientation(ev){
      let hdg = null;
      // iOS Safari provides webkitCompassHeading (0=N, clockwise)
      if (typeof ev.webkitCompassHeading === 'number'){
        hdg = ev.webkitCompassHeading;
      } else if (typeof ev.alpha === 'number'){
        // alpha is 0 at device facing 'north' in some browsers; convert approx to compass
        // Use absolute if available
        const base = ev.absolute ? ev.alpha : (360 - ev.alpha); // heuristic
        // adjust for screen orientation
        const ang = (screen.orientation && typeof screen.orientation.angle==='number') ? screen.orientation.angle : (window.orientation||0);
        hdg = (base + ang + 360) % 360;
      }
      if (hdg!=null){
        // simple low-pass filter
        const s = 0.2;
        lastHeading = (lastHeading==null) ? hdg : (lastHeading*(1-s) + hdg*s);
      }
    }

    // ========================
    // Export
    // ========================
    function csvEscape(val){
      const s = String(val).replace(/\r?\n/g,' ');
      if (/[",;]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }
    function exportarCSV(){
      const arr = getUbicaciones();
      if (!arr.length){ alert(textos[lang].no_hay); return; }
      const headers = ['id','nombre','lat','lon','fechaISO','fechaLocal'];
      const lines = [headers.join(',')].concat(arr.map(u =>
        [u.id, u.nombre||'', u.lat, u.lon, u.fechaISO||'', u.fechaLocal||''].map(csvEscape).join(',')
      ));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ubicaciones.csv'; a.click();
    }
    function exportarGPX(){
      const arr = getUbicaciones();
      if (!arr.length){ alert(textos[lang].no_hay); return; }
      const wpts = arr.map(u => 
        `  <wpt lat="${u.lat}" lon="${u.lon}"><name>${(u.nombre||"")}</name>${u.fechaISO?`<time>${u.fechaISO}</time>`:''}</wpt>`
      ).join('\n');
      const gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="PuntoYa" xmlns="http://www.topografix.com/GPX/1/1">
${wpts}
</gpx>`;
      const blob = new Blob([gpx], {type:'application/gpx+xml'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ubicaciones.gpx'; a.click();
    }

    // ========================
    // Permissions API (best effort)
    // ========================
    async function revisarPermisos(){
      if (!('permissions' in navigator)) return;
      try{
        const p = await navigator.permissions.query({name:'geolocation'});
        setGpsEstado((lang==='es'?'Permiso geoloc.: ':'Geoloc. permission: ') + p.state);
        p.onchange = ()=> setGpsEstado((lang==='es'?'Permiso geoloc.: ':'Geoloc. permission: ') + p.state);
      }catch(e){/* ignore */}
    }

    // ========================
    // Event bindings + init
    // ========================
    document.addEventListener('DOMContentLoaded', () => {
      // Language
      document.querySelectorAll('.lang-selector button').forEach(btn=>{
        btn.addEventListener('click', () => {
          lang = btn.dataset.lang || 'es';
          localStorage.setItem('py_lang', lang);
          aplicarTraduccion();
        });
      });

      aplicarTraduccion();
      renderizarUbicaciones();
      actualizarContador();
      revisarPermisos();

      // Inputs
      document.getElementById('btn-guardar').addEventListener('click', guardarUbicacion);
      document.getElementById('buscar').addEventListener('input', renderizarUbicaciones);
      document.getElementById('btn-exportar-csv').addEventListener('click', exportarCSV);
      document.getElementById('btn-exportar-gpx').addEventListener('click', exportarGPX);
      document.getElementById('btn-mapa').addEventListener('click', abrirEnMaps);
      document.getElementById('btn-navegar').addEventListener('click', iniciarNavegacion);
      document.getElementById('btn-detener').addEventListener('click', detenerNavegacion);
      document.getElementById('btn-permiso-orientacion').addEventListener('click', solicitarPermisoOrientacion);

      // iOS orientation permission button visibility
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent) && typeof DeviceOrientationEvent?.requestPermission === 'function') {
        // show later when navigating; keep hidden for now
      } else {
        // pre-activate orientation for non-iOS modern
        activarOrientacion();
      }
    });
  </script>
</body>
</html>
